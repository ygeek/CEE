# 世界模块

## 世界地图

### 基本逻辑描述
1. 用户打开客户端，GPS定位获取当前定位坐标。
2. 向服务器上报当前坐标，服务端匹配最近的地图的id，告知客户端。这里需要考虑性能优化的问题。
3. 打开App的情况下，根据当前实时坐标查询最近的地图，并给出发现地图的消息提示。（考虑周期性的查询）
3. 客户端根据地图id下载地图。
4. 客户端根据地图id获取锚点。
5. 完成整张地图的锚点时间以后，服务端匹配最近的另外一张未完成的地图的ID，推荐给客户端。

### 涉及到的实体
#### 地图 (Map)
|字段|类型|说明|
|:-:|:-:|:-:|
|map_id|string|地图ID|
|name|string|地图名称|
|desc|string|地图描述|
|x|double|地图经度|
|y|double|地图纬度|
|image_url|string|地图背景图URL|

#### 用户地图关系
|字段|类型|说明|
|:-:|:-:|:-:|
|map_id|string|地图ID|
|user_id|string|用户ID|
|visited|bool|标记是否访问过|
|completed|bool|标记是否已经完成地图所有任务|

#### 锚点 (Anchor)
|字段|类型|说明|
|:-:|:-:|:-:|
|anchor_id|string|锚点ID|
|name|string|锚点名称|
|desc|string|锚点描述|
|dx|string|锚点相对地图的x坐标|
|dy|string|锚点相对地图的y坐标|

#### 用户锚点关系
|字段|类型|说明|
|:-:|:-:|:-:|
|anchor_id|string|锚点ID|
|user_id|string|用户ID|
|completed|bool|标记是否完成|

## 题组 (task)

### 基本逻辑描述
1. 点击地图上选择题锚点，进入选择题组。
2. 题组是一组线性的选择体交互。
3. 每一步是由一道选择题和答题之后的提示组成。
4. 选择题是一幅图 + 一段文字 + 最多四个选项 + 一个答案。
5. 答题后的提示是一幅图 + 一段文字。
6. 完成整组题目后，可以获得相应勋章。

### 涉及到的实体
#### 锚点与任务关系
|字段|类型|说明|
|:-:|:-:|:-:|
|anchor_id|string|锚点ID|
|task_id|string|题组ID|

#### 题组
|字段|类型|说明|
|:-:|:-:|:-:|
|task_id|string|任务ID|
|name|string|任务名称|
|desc|string|任务描述|
|choice_ids|array<string>|选择题ID列表|
|medal_id|string|完成后获得的勋章ID|

#### 选择题
|字段|类型|说明|
|:-:|:-:|:-:|
|choice_id|string|选择题ID|
|name|string|选择题名称|
|desc|string|选择题描述|
|img_url|string|选择题配图URL|
|options|array<string>|选择题选项列表|
|answer|short|选择题答案|

#### 勋章 
|字段|类型|说明|
|:-:|:-:|:-:|
|medal_id|string|勋章ID|
|name|string|勋章名称|
|desc|string|勋章描述|
|icon_url|string|勋章图标URL|
|map_id|string|关联的地图ID|

####  用户勋章关系
|字段|类型|说明|
|:-:|:-:|:-:|
|user_id|string|用户ID|
|medal_id|string|勋章ID|

# 故事模块

### 基本逻辑描述
1. 故事列表依据当前地理位置只加载当前城市里的故事。
2. 点击地图上的锚点进入故事，或者在故事列表中点击进入。
3. 故事由关卡线性组成。用户通过关卡，最终完成整个故事。
4. 整体故事完成后可获得金币奖励
5. 关卡完成后，奖励优惠券。
6. 关卡的类别：过场类（视频、图片+文字形式的对话），答题操作类（数字答题、文字答题），空白关卡（需要借助道具通过），H5小游戏（预留下一关的触发接口）。
7. 道具在背包里，用来辅助用户完成整个故事。道具在完成某个关卡之后被激活。只有激活的道具可以使用。
8. 三类道具：导航（跳转到导航app，即完成事件的触发），纸条（展示一段文字），锁箱（一段文字说明，点击触发下一关）。
9. 需要记录用户故事的进度。
10. 故事有一些基本信息：完成故事预计的时间、故事被点赞次数、完成故事需要走动的距离，多张封面图，一段文字说明，难度，标签，对应的一系列关卡。
11. 关卡对应的优惠券有数量限制，单一关卡不限制优惠券的种类数

### 涉及到的实体
5. 背包 `(user_id, [item_ids])`

#### 故事

|字段|类型|说明|
|:-:|:-:|:-:|
|`story_id`|string|故事ID|
|`name`|string|故事名称|
|`desc`|string|故事描述|
|`cover_img_urls`|array<string>|封面图片URL数组|
|`time`|int|故事预计完成时间（单位分）|
|`good`|int|故事被点赞次数|
|`distance`|double|完成故事预计需要移动的距离|
|`level_ids`|array<string>|故事涉及的关卡ID的列表|
|`city`|string|故事的城市|

#### 关卡
|字段|类型|说明|
|:-:|:-:|:-:|
|`level_id`|string|关卡ID|
|`type`|string|关卡类型：video, dialog, number, text, h5|
|`name`|string|关卡名称（可选）|
|`video_url`|string|关卡视频URL（只有video关卡有值）|
|`img_url`|string|图片URL（dialog, number, text）|
|`text`|string|说明文字 (dialog, number, text)|
|`number_answer`|string|数字关卡里的答案|
|`h5_url`|string|h5关卡里的H5页面URL|

// TODO (zhangmeng)：需要设计一下多段填空题的数据格式

#### 道具
|字段|类型|说明|
|:-:|:-:|:-:|
|`item_id`|string|道具ID|
|`type`|string|道具类型|
|`title`|string|道具标题|
|`desc`|string|道具描述|
|`data`|string|道具附带额外信息（例如导航道具附带的导航地址）|

#### 背包（用户道具关系）
|字段|类型|说明|
|:-:|:-:|:-:|
|`user_id`|string|用户ID|
|`item_id`|string|道具ID|
|`state`|string|状态：active, disable|

#### 锚点与故事关系
|字段|类型|说明|
|:-:|:-:|:-:|
|`anchor_id`|string|锚点ID|
|`story_id`|string|故事ID|

#### 优惠券
|字段|类型|说明|
|:-:|:-:|:-:|
|`coupon_id`|string|优惠券ID|
|`gmt_start`|long long|优惠券开始GMT时间戳|
|`gmt_end`|long long|优惠券过期GMT时间戳|
|`name`|string|优惠券名称|
|`desc`|string|优惠券描述|
|`state`|string|优惠券状态：init, consumed|
|`is_delete`|bool|优惠券删除标记|
|`code`|string|优惠券密码|

#### 用户金币
|字段|类型|说明|
|:-:|:-:|:-:|
|`user_id`|string|用户ID|
|`gold`|string|金币数量|

#### 用户优惠券关系
|字段|类型|说明|
|:-:|:-:|:-:|
|`user_id`|string|用户ID|
|`coupon_id`|string|优惠券ID|

# 用户模块

### 基本功能

1. 用户注册，用户名，邮箱，密码。
2. 用户名、邮箱登录。
3. 匿名用户登录。
4. 微博、微信、QQ登录。
5. 个人信息。

### 涉及到的实体

#### 用户 
|字段|类型|说明|
|:-:|:-:|:-:|
|`user_id`|string|用户ID|
|`gmt_created`|long long|用户创建时间的GMT时间戳|
|`gmt_modified`|long long|用户修改时间的GMT时间戳|
|`username`|string|用户名|
|`nickname`|string|用户昵称|
|`email`|string|用户邮箱|
|`password`|string|加密的用户密码|
|`head_url`|string|用户头像的URL|
|`sex`|short|用户性别，0-未知，1-男，2-女|
|`is_deleted`|bool|删除标记|
|`mobile`|string|手机号|

#### 第三方帐号关联
|字段|类型|说明|
|:-:|:-:|:-:|
|`type`|string|表明关联帐号的类型：weibo, qq, weixin|
|`extern_id`|string|第三方帐号ID|
|`user_id`|string|关联的帐号ID|

#### 用户好友关系
|字段|类型|说明|
|:-:|:-:|:-:|
|`user_id`|string|用户ID|
|`friend_id`|string|朋友ID|


# 消息系统

### 基本功能
1. 消息列表里可以看到全部消息。
2. 消息的四个来源：正在进行的故事（本地生成）、优惠券过期之前五天（系统推送）、随着定位变化发现新地图消息推送（本地生成）、运营推送的消息（系统推送）。

### 涉及到的实体

#### 消息 
|字段|类型|说明|
|:-:|:-:|:-:|
|msg_id|string|消息ID|
|user_id|string|消息接受者ID|
|icon_url|string|消息图标URL|
|date|string|消息时间|
|text|string|消息内容|
|unread|bool|消息未读标记|
|is_deleted|bool|消息删除标记|

---

#管理后台

##优惠券系统

### 基本功能
1. 优惠券列表中可完成对优惠券种类信息的增删改查；
2. 优惠券信息包括 ：餐厅名称，优惠券秘钥，优惠信息项（多条），优惠信息细则（多条）；
3. 详情页查看某优惠券的在不同故事下的获得情况，以及已发放的优惠券的详细使用情况。

##用户管理

### 基本功能

1. 用户列表可完成对用户信息的增删改查；
2. 列表项内展示用户ID、昵称、手机号/第三方账号、金币数、注册时间，其余信息收入详情页；
3. 详情页可查询用户的所有基本信息：用户更ID、昵称、手机号/第三方账号、金币数、已获得优惠券&使用情况、已完成的世界、已完成的故事。

##世界管理
### 基本功能
1. 世界列表可完成对世界的增删该改查
2. 列表项内展示世界ID、世界对应城市、已获得人数、已通关人数
3. 详情页可查看世界详细信息，世界详细信息见下
4. 新增、编辑世界分为以下几部分数据：
	- 选择城市
	- 选择区域定位坐标
	- 上传底图
	- 新增锚点
	- 选择锚点类型
	- 选择锚点关联故事/新增编辑选择题
	- 新增当前世界对应徽章

##故事管理
### 基本功能
1. 故事列表可完成对故事的增删改查
2. 列表项内展示故事ID、故事对应城市、已开始人数、已通关人数
3. 详情页可查看故事详细信息，故事详细信息见下：
4. 新增、编辑㐊分为以下几部分数据：
	- 选择城市
	- 编辑关卡基本信息
		- 封面
		- 内部轮播图
		- 关卡介绍
		- 标签
		- 路线难度
		- 建议时长
		- 建议距离
		- 示意路线图
		- 金币
	- 添加关卡
		- 选择关卡模板&添加关卡信息
		- 选择过场模板&添加过场
		- 添加优惠券（选择优惠券管理中已有的优惠券，编辑数量）
	- 添加道具
		- 选择道具模板&添加道具信息
		- 设置道具激活时间、道具跳转关卡

##选择题管理已废除